# 分发器
整个在线支部系统由两部分组成:分发器和节点.其中节点负责具体的客户端之间的信息沟通,而分发器负责将客户端分配到合适的节点
## **功能**

### 当前
* 为在线支部提供登陆路由
* 管理支部在在线支部应用节点(以下均称节点)上的分布
* 将支部分配到应用节点上
* 查询支部,个人所在节点

### 未来
* *清理不活跃支部*
* *调整支部在节点上的分布*

## **功能模块**

### 0. 数据载入和更新
* 从 mongo 中加载支部和用户信息到数据库( redis)中
* 接收 nsq 消息,当支部和用户信息变更时,更新数据库,并提醒 node 更新数据

### 1. 注册节点
* 节点启动后需要向分发器注册,成功后才能进入系统
* 每个节点设定自身所能承载的支部数量上限及其它参数,向分发器请求注册
* 分发器收到注册请求后,将节点信息添加到数据库(redis)中,并向该节点分配承载的支部

### 2. 检测和处理节点状态
* 定期检查节点的有效性,无效则将其清除
* 将无效节点原先承载的支部置为无承载状态

### 3. 处理节点请求
* 接收节点请求更新承载量
* 更新节点请求更新参数信息

### 4. 处理登录路由请求
* 分发器接受请求后,检查是否请求的支部在 redis 中存在
* 如果存在,则返回该支部所在的节点地址;如果不存在,返回空


## **redis 数据定义**

* 节点信息  

    ```SET "nodes" 192.168.1.1,10,0 192.168.1.2,10,0  {ip},{最大承载量},{当前承载量} 节点上线后注册到该列表中;分配之后更新已承载的支部数量```
* 节点上支部的分配信息

    ``` STRING key "group:node:{groupID}"  "node IP"   根据支部ID查找节点```


## **API定义**

### 1. 终端访问链接 
*连接格式*
> ```http://{:domain}/login?id={:id}&group={:group}```

*返回结果*
```
{code: 0, message: "", data: {url:"/ws?group=1464166343_1466516625235830686&id=1466516625234946176", hosts:["ws://127.0.0.1:8083"]}}
```

## **一些想法**

1. 当前业务中,党员局限于唯一的支部,映射到系统中就是一个用户只会出现在一个聊天组里.但是一个通用型的聊天系统,不应该做此限制;而且即使对应到业务中,用户也会因为所在支部的调整而分布到不同的支部中

